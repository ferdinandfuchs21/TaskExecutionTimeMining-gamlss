library(gamlss)
library(readr)
library(dplyr)
library(ggplot2)
library(Metrics)
library(knitr)
library(gamlss.dist)
library(scoringRules)
library(stats)

BPIC2017_train <- read_csv("../../data/BPIC2017/transformed_event_logs/BPIC2017_train.csv")
BPIC2017_test  <- read_csv("../../data/BPIC2017/transformed_event_logs/BPIC2017_test.csv")

input_vars <- list(
  var1 = "concept:name",
  var2 = "org:resource_start",
  var3 = "seconds_in_day",
  var4 = "day_of_week",
  var5 = "W_Validate_application",
  var6 = "W_Call_after_offers",
  var7 = "W_Call_incomplete_files",
  var8 = "W_Handle_leads",
  var9 = "W_Complete_application",
  var10 = "W_Assess_potential_fraud",
  var11 = "W_Shortened_completion_",
  var12 = "User_112",
  var13 = "User_63",
  var14 = "User_80",
  var15 = "User_30",
  var16 = "User_114",
  var17 = "User_51",
  var18 = "User_5",
  var19 = "User_61",
  var20 = "User_46",
  var21 = "User_87",
  var22 = "User_67",
  var23 = "User_29",
  var24 = "User_27",
  var25 = "User_96",
  var26 = "User_121",
  var27 = "User_15",
  var28 = "User_38",
  var29 = "User_17",
  var30 = "User_1",
  var31 = "User_28",
  var32 = "User_100",
  var33 = "User_133",
  var34 = "User_68",
  var35 = "User_52",
  var36 = "User_57",
  var37 = "User_12",
  var38 = "User_3",
  var39 = "User_45",
  var40 = "User_37",
  var41 = "User_7",
  var42 = "User_119",
  var43 = "User_85",
  var44 = "User_136",
  var45 = "User_74",
  var46 = "User_48",
  var47 = "User_118",
  var48 = "User_4",
  var49 = "User_44",
  var50 = "User_120",
  var51 = "User_128",
  var52 = "User_126",
  var53 = "User_31",
  var54 = "User_34",
  var55 = "User_101",
  var56 = "User_123",
  var57 = "User_23",
  var58 = "User_49",
  var59 = "User_130",
  var60 = "User_99",
  var61 = "User_2",
  var62 = "User_122",
  var63 = "User_83",
  var64 = "User_11",
  var65 = "User_62",
  var66 = "User_9",
  var67 = "User_65",
  var68 = "User_41",
  var69 = "User_21",
  var70 = "User_36",
  var71 = "User_18",
  var72 = "User_117",
  var73 = "User_90",
  var74 = "User_40",
  var75 = "User_39",
  var76 = "User_14",
  var77 = "User_73",
  var78 = "User_53",
  var79 = "User_25",
  var80 = "User_54",
  var81 = "User_26",
  var82 = "User_70",
  var83 = "User_116",
  var84 = "User_109",
  var85 = "User_93",
  var86 = "User_19",
  var87 = "User_43",
  var88 = "User_97",
  var89 = "User_84",
  var90 = "User_13",
  var91 = "User_125",
  var92 = "User_33",
  var93 = "User_60",
  var94 = "User_75",
  var95 = "User_105",
  var96 = "User_108",
  var97 = "User_113",
  var98 = "User_106",
  var99 = "User_42",
  var100 = "User_16",
  var101 = "User_131",
  var102 = "User_94",
  var103 = "User_124",
  var104 = "User_104",
  var105 = "User_102",
  var106 = "User_132",
  var107 = "User_24",
  var108 = "User_95",
  var109 = "User_98",
  var110 = "User_69",
  var111 = "User_35",
  var112 = "User_137",
  var113 = "User_91",
  var114 = "User_22",
  var115 = "User_58",
  var116 = "User_86",
  var117 = "User_135",
  var118 = "User_56",
  var119 = "User_32",
  var120 = "User_71",
  var121 = "User_10",
  var122 = "User_77",
  var123 = "User_141",
  var124 = "User_134",
  var125 = "User_72",
  var126 = "User_66",
  var127 = "User_47",
  var128 = "User_20",
  var129 = "User_115",
  var130 = "User_138",
  var131 = "User_79",
  var132 = "User_78",
  var133 = "User_64",
  var134 = "User_144",
  var135 = "User_107",
  var136 = "User_140",
  var137 = "User_81",
  var138 = "User_8",
  var139 = "User_92",
  var140 = "User_50",
  var141 = "User_82",
  var142 = "User_127",
  var143 = "User_143",
  var144 = "User_59",
  var145 = "User_142",
  var146 = "User_89",
  var147 = "User_129",
  var148 = "User_6",
  var149 = "User_55",
  var150 = "User_76",
  var151 = "User_88",
  var152 = "User_139",
  var153 = "User_103",
  var154 = "User_111",
  var155 = "User_110",
  var156 = "User_146",
  var157 = "User_149",
  var158 = "User_145",
  var159 = "User_147",
  var160 = "User_148"
)
distribution_family <- LOGNO()


rename_for_model <- function(df, var_list) {
  df %>%
    rename(
      variable1 = !!sym(var_list$var1),
      variable2 = !!sym(var_list$var2),
      variable3 = !!sym(var_list$var3),
      variable4 = !!sym(var_list$var4),
      variable5 = !!sym(var_list$var5),
      variable6 = !!sym(var_list$var6),
      variable7 = !!sym(var_list$var7),
      variable8 = !!sym(var_list$var8),
      variable9 = !!sym(var_list$var9),
      variable10 = !!sym(var_list$var10),
      variable11 = !!sym(var_list$var11),
      variable12 = !!sym(var_list$var12),
      variable13 = !!sym(var_list$var13),
      variable14 = !!sym(var_list$var14),
      variable15 = !!sym(var_list$var15),
      variable16 = !!sym(var_list$var16),
      variable17 = !!sym(var_list$var17),
      variable18 = !!sym(var_list$var18),
      variable19 = !!sym(var_list$var19),
      variable20 = !!sym(var_list$var20),
      variable21 = !!sym(var_list$var21),
      variable22 = !!sym(var_list$var22),
      variable23 = !!sym(var_list$var23),
      variable24 = !!sym(var_list$var24),
      variable25 = !!sym(var_list$var25),
      variable26 = !!sym(var_list$var26),
      variable27 = !!sym(var_list$var27),
      variable28 = !!sym(var_list$var28),
      variable29 = !!sym(var_list$var29),
      variable30 = !!sym(var_list$var30),
      variable31 = !!sym(var_list$var31),
      variable32 = !!sym(var_list$var32),
      variable33 = !!sym(var_list$var33),
      variable34 = !!sym(var_list$var34),
      variable35 = !!sym(var_list$var35),
      variable36 = !!sym(var_list$var36),
      variable37 = !!sym(var_list$var37),
      variable38 = !!sym(var_list$var38),
      variable39 = !!sym(var_list$var39),
      variable40 = !!sym(var_list$var40),
      variable41 = !!sym(var_list$var41),
      variable42 = !!sym(var_list$var42),
      variable43 = !!sym(var_list$var43),
      variable44 = !!sym(var_list$var44),
      variable45 = !!sym(var_list$var45),
      variable46 = !!sym(var_list$var46),
      variable47 = !!sym(var_list$var47),
      variable48 = !!sym(var_list$var48),
      variable49 = !!sym(var_list$var49),
      variable50 = !!sym(var_list$var50),
      variable51 = !!sym(var_list$var51),
      variable52 = !!sym(var_list$var52),
      variable53 = !!sym(var_list$var53),
      variable54 = !!sym(var_list$var54),
      variable55 = !!sym(var_list$var55),
      variable56 = !!sym(var_list$var56),
      variable57 = !!sym(var_list$var57),
      variable58 = !!sym(var_list$var58),
      variable59 = !!sym(var_list$var59),
      variable60 = !!sym(var_list$var60),
      variable61 = !!sym(var_list$var61),
      variable62 = !!sym(var_list$var62),
      variable63 = !!sym(var_list$var63),
      variable64 = !!sym(var_list$var64),
      variable65 = !!sym(var_list$var65),
      variable66 = !!sym(var_list$var66),
      variable67 = !!sym(var_list$var67),
      variable68 = !!sym(var_list$var68),
      variable69 = !!sym(var_list$var69),
      variable70 = !!sym(var_list$var70),
      variable71 = !!sym(var_list$var71),
      variable72 = !!sym(var_list$var72),
      variable73 = !!sym(var_list$var73),
      variable74 = !!sym(var_list$var74),
      variable75 = !!sym(var_list$var75),
      variable76 = !!sym(var_list$var76),
      variable77 = !!sym(var_list$var77),
      variable78 = !!sym(var_list$var78),
      variable79 = !!sym(var_list$var79),
      variable80 = !!sym(var_list$var80),
      variable81 = !!sym(var_list$var81),
      variable82 = !!sym(var_list$var82),
      variable83 = !!sym(var_list$var83),
      variable84 = !!sym(var_list$var84),
      variable85 = !!sym(var_list$var85),
      variable86 = !!sym(var_list$var86),
      variable87 = !!sym(var_list$var87),
      variable88 = !!sym(var_list$var88),
      variable89 = !!sym(var_list$var89),
      variable90 = !!sym(var_list$var90),
      variable91 = !!sym(var_list$var91),
      variable92 = !!sym(var_list$var92),
      variable93 = !!sym(var_list$var93),
      variable94 = !!sym(var_list$var94),
      variable95 = !!sym(var_list$var95),
      variable96 = !!sym(var_list$var96),
      variable97 = !!sym(var_list$var97),
      variable98 = !!sym(var_list$var98),
      variable99 = !!sym(var_list$var99),
      variable100 = !!sym(var_list$var100),
      variable101 = !!sym(var_list$var101),
      variable102 = !!sym(var_list$var102),
      variable103 = !!sym(var_list$var103),
      variable104 = !!sym(var_list$var104),
      variable105 = !!sym(var_list$var105),
      variable106 = !!sym(var_list$var106),
      variable107 = !!sym(var_list$var107),
      variable108 = !!sym(var_list$var108),
      variable109 = !!sym(var_list$var109),
      variable110 = !!sym(var_list$var110),
      variable111 = !!sym(var_list$var111),
      variable112 = !!sym(var_list$var112),
      variable113 = !!sym(var_list$var113),
      variable114 = !!sym(var_list$var114),
      variable115 = !!sym(var_list$var115),
      variable116 = !!sym(var_list$var116),
      variable117 = !!sym(var_list$var117),
      variable118 = !!sym(var_list$var118),
      variable119 = !!sym(var_list$var119),
      variable120 = !!sym(var_list$var120),
      variable121 = !!sym(var_list$var121),
      variable122 = !!sym(var_list$var122),
      variable123 = !!sym(var_list$var123),
      variable124 = !!sym(var_list$var124),
      variable125 = !!sym(var_list$var125),
      variable126 = !!sym(var_list$var126),
      variable127 = !!sym(var_list$var127),
      variable128 = !!sym(var_list$var128),
      variable129 = !!sym(var_list$var129),
      variable130 = !!sym(var_list$var130),
      variable131 = !!sym(var_list$var131),
      variable132 = !!sym(var_list$var132),
      variable133 = !!sym(var_list$var133),
      variable134 = !!sym(var_list$var134),
      variable135 = !!sym(var_list$var135),
      variable136 = !!sym(var_list$var136),
      variable137 = !!sym(var_list$var137),
      variable138 = !!sym(var_list$var138),
      variable139 = !!sym(var_list$var139),
      variable140 = !!sym(var_list$var140),
      variable141 = !!sym(var_list$var141),
      variable142 = !!sym(var_list$var142),
      variable143 = !!sym(var_list$var143),
      variable144 = !!sym(var_list$var144),
      variable145 = !!sym(var_list$var145),
      variable146 = !!sym(var_list$var146),
      variable147 = !!sym(var_list$var147),
      variable148 = !!sym(var_list$var148),
      variable149 = !!sym(var_list$var149),
      variable150 = !!sym(var_list$var150),
      variable151 = !!sym(var_list$var151),
      variable152 = !!sym(var_list$var152),
      variable153 = !!sym(var_list$var153),
      variable154 = !!sym(var_list$var154),
      variable155 = !!sym(var_list$var155),
      variable156 = !!sym(var_list$var156),
      variable157 = !!sym(var_list$var157),
      variable158 = !!sym(var_list$var158),
      variable159 = !!sym(var_list$var159),
      variable160 = !!sym(var_list$var160)
    )
}

BPIC2017_train <- rename_for_model(BPIC2017_train, input_vars)
BPIC2017_test  <- rename_for_model(BPIC2017_test, input_vars)


mu_formula <- duration_seconds ~ variable1 + variable2 + variable3 + variable4 + variable5 + variable6 + variable7 + variable8 + variable9 + variable10 + variable11 +
  variable12 + variable13 + variable14 + variable15 + variable16 + variable17 + variable18 + variable19 + variable20 + variable21 + variable22 + variable23 + variable24 + variable25 +
  variable26 + variable27 + variable28 + variable29 + variable30 + variable31 + variable32 + variable33 + variable34 + variable35 + variable36 + variable37 + variable38 + variable39 + variable40 +
  variable41 + variable42 + variable43 + variable44 + variable45 + variable46 + variable47 + variable48 + variable49 + variable50 + variable51 + variable52 + variable53 + variable54 + variable55 +
  variable56 + variable57 + variable58 + variable59 + variable60 + variable61 + variable62 + variable63 + variable64 + variable65 + variable66 + variable67 + variable68 + variable69 + variable70 +
  variable71 + variable72 + variable73 + variable74 + variable75 + variable76 + variable77 + variable78 + variable79 + variable80 + variable81 + variable82 + variable83 + variable84 + variable85 +
  variable86 + variable87 + variable88 + variable89 + variable90 + variable91 + variable92 + variable93 + variable94 + variable95 + variable96 + variable97 + variable98 + variable99 + variable100 +
  variable101 + variable102 + variable103 + variable104 + variable105 + variable106 + variable107 + variable108 + variable109 + variable110 + variable111 + variable112 + variable113 + variable114 + variable115 +
  variable116 + variable117 + variable118 + variable119 + variable120 + variable121 + variable122 + variable123 + variable124 + variable125 + variable126 + variable127 + variable128 + variable129 + variable130 +
  variable131 + variable132 + variable133 + variable134 + variable135 + variable136 + variable137 + variable138 + variable139 + variable140 + variable141 + variable142 + variable143 + variable144 + variable145 +
  variable146 + variable147 + variable148 + variable149 + variable150 + variable151 + variable152 + variable153 + variable154 + variable155 + variable156 + variable157 + variable158 + variable159 + variable160

sigma_formula <- ~ variable1 + variable2 + variable3 + variable4 + variable5 + variable6 + variable7 + variable8 + variable9 + variable10 + variable11 +
  variable12 + variable13 + variable14 + variable15 + variable16 + variable17 + variable18 + variable19 + variable20 + variable21 + variable22 + variable23 + variable24 + variable25 +
  variable26 + variable27 + variable28 + variable29 + variable30 + variable31 + variable32 + variable33 + variable34 + variable35 + variable36 + variable37 + variable38 + variable39 + variable40 +
  variable41 + variable42 + variable43 + variable44 + variable45 + variable46 + variable47 + variable48 + variable49 + variable50 + variable51 + variable52 + variable53 + variable54 + variable55 +
  variable56 + variable57 + variable58 + variable59 + variable60 + variable61 + variable62 + variable63 + variable64 + variable65 + variable66 + variable67 + variable68 + variable69 + variable70 +
  variable71 + variable72 + variable73 + variable74 + variable75 + variable76 + variable77 + variable78 + variable79 + variable80 + variable81 + variable82 + variable83 + variable84 + variable85 +
  variable86 + variable87 + variable88 + variable89 + variable90 + variable91 + variable92 + variable93 + variable94 + variable95 + variable96 + variable97 + variable98 + variable99 + variable100 +
  variable101 + variable102 + variable103 + variable104 + variable105 + variable106 + variable107 + variable108 + variable109 + variable110 + variable111 + variable112 + variable113 + variable114 + variable115 +
  variable116 + variable117 + variable118 + variable119 + variable120 + variable121 + variable122 + variable123 + variable124 + variable125 + variable126 + variable127 + variable128 + variable129 + variable130 +
  variable131 + variable132 + variable133 + variable134 + variable135 + variable136 + variable137 + variable138 + variable139 + variable140 + variable141 + variable142 + variable143 + variable144 + variable145 +
  variable146 + variable147 + variable148 + variable149 + variable150 + variable151 + variable152 + variable153 + variable154 + variable155 + variable156 + variable157 + variable158 + variable159 + variable160

model_gamlss <- gamlss(
  mu_formula,
  sigma_formula,
  data = BPIC2017_train,
  family = distribution_family,
  n.cyc = 500,
  trace = TRUE
)

BPIC2017_train <- BPIC2017_train %>%
  mutate(
    pred_mu = predict(model_gamlss, what = "mu", type = "response"),
    pred_sigma = predict(model_gamlss, what = "sigma", type = "response")
  )

BPIC2017_test <- BPIC2017_test %>%
  mutate(
    pred_mu = predict(model_gamlss, what = "mu", type = "response", newdata = BPIC2017_test),
    pred_sigma = predict(model_gamlss, what = "sigma", type = "response", newdata = BPIC2017_test)
  )

rename_back <- function(df, var_list) {
  df %>%
    rename(
      !!var_list$var1 := variable1,
      !!var_list$var2 := variable2,
      !!var_list$var3 := variable3,
      !!var_list$var4 := variable4,
      !!var_list$var5 := variable5,
      !!var_list$var6 := variable6,
      !!var_list$var7 := variable7,
      !!var_list$var8 := variable8,
      !!var_list$var9 := variable9,
      !!var_list$var10 := variable10,
      !!var_list$var11 := variable11,
      !!var_list$var12 := variable12,
      !!var_list$var13 := variable13,
      !!var_list$var14 := variable14,
      !!var_list$var15 := variable15,
      !!var_list$var16 := variable16,
      !!var_list$var17 := variable17,
      !!var_list$var18 := variable18,
      !!var_list$var19 := variable19,
      !!var_list$var20 := variable20,
      !!var_list$var21 := variable21,
      !!var_list$var22 := variable22,
      !!var_list$var23 := variable23,
      !!var_list$var24 := variable24,
      !!var_list$var25 := variable25,
      !!var_list$var26 := variable26,
      !!var_list$var27 := variable27,
      !!var_list$var28 := variable28,
      !!var_list$var29 := variable29,
      !!var_list$var30 := variable30,
      !!var_list$var31 := variable31,
      !!var_list$var32 := variable32,
      !!var_list$var33 := variable33,
      !!var_list$var34 := variable34,
      !!var_list$var35 := variable35,
      !!var_list$var36 := variable36,
      !!var_list$var37 := variable37,
      !!var_list$var38 := variable38,
      !!var_list$var39 := variable39,
      !!var_list$var40 := variable40,
      !!var_list$var41 := variable41,
      !!var_list$var42 := variable42,
      !!var_list$var43 := variable43,
      !!var_list$var44 := variable44,
      !!var_list$var45 := variable45,
      !!var_list$var46 := variable46,
      !!var_list$var47 := variable47,
      !!var_list$var48 := variable48,
      !!var_list$var49 := variable49,
      !!var_list$var50 := variable50,
      !!var_list$var51 := variable51,
      !!var_list$var52 := variable52,
      !!var_list$var53 := variable53,
      !!var_list$var54 := variable54,
      !!var_list$var55 := variable55,
      !!var_list$var56 := variable56,
      !!var_list$var57 := variable57,
      !!var_list$var58 := variable58,
      !!var_list$var59 := variable59,
      !!var_list$var60 := variable60,
      !!var_list$var61 := variable61,
      !!var_list$var62 := variable62,
      !!var_list$var63 := variable63,
      !!var_list$var64 := variable64,
      !!var_list$var65 := variable65,
      !!var_list$var66 := variable66,
      !!var_list$var67 := variable67,
      !!var_list$var68 := variable68,
      !!var_list$var69 := variable69,
      !!var_list$var70 := variable70,
      !!var_list$var71 := variable71,
      !!var_list$var72 := variable72,
      !!var_list$var73 := variable73,
      !!var_list$var74 := variable74,
      !!var_list$var75 := variable75,
      !!var_list$var76 := variable76,
      !!var_list$var77 := variable77,
      !!var_list$var78 := variable78,
      !!var_list$var79 := variable79,
      !!var_list$var80 := variable80,
      !!var_list$var81 := variable81,
      !!var_list$var82 := variable82,
      !!var_list$var83 := variable83,
      !!var_list$var84 := variable84,
      !!var_list$var85 := variable85,
      !!var_list$var86 := variable86,
      !!var_list$var87 := variable87,
      !!var_list$var88 := variable88,
      !!var_list$var89 := variable89,
      !!var_list$var90 := variable90,
      !!var_list$var91 := variable91,
      !!var_list$var92 := variable92,
      !!var_list$var93 := variable93,
      !!var_list$var94 := variable94,
      !!var_list$var95 := variable95,
      !!var_list$var96 := variable96,
      !!var_list$var97 := variable97,
      !!var_list$var98 := variable98,
      !!var_list$var99 := variable99,
      !!var_list$var100 := variable100,
      !!var_list$var101 := variable101,
      !!var_list$var102 := variable102,
      !!var_list$var103 := variable103,
      !!var_list$var104 := variable104,
      !!var_list$var105 := variable105,
      !!var_list$var106 := variable106,
      !!var_list$var107 := variable107,
      !!var_list$var108 := variable108,
      !!var_list$var109 := variable109,
      !!var_list$var110 := variable110,
      !!var_list$var111 := variable111,
      !!var_list$var112 := variable112,
      !!var_list$var113 := variable113,
      !!var_list$var114 := variable114,
      !!var_list$var115 := variable115,
      !!var_list$var116 := variable116,
      !!var_list$var117 := variable117,
      !!var_list$var118 := variable118,
      !!var_list$var119 := variable119,
      !!var_list$var120 := variable120,
      !!var_list$var121 := variable121,
      !!var_list$var122 := variable122,
      !!var_list$var123 := variable123,
      !!var_list$var124 := variable124,
      !!var_list$var125 := variable125,
      !!var_list$var126 := variable126,
      !!var_list$var127 := variable127,
      !!var_list$var128 := variable128,
      !!var_list$var129 := variable129,
      !!var_list$var130 := variable130,
      !!var_list$var131 := variable131,
      !!var_list$var132 := variable132,
      !!var_list$var133 := variable133,
      !!var_list$var134 := variable134,
      !!var_list$var135 := variable135,
      !!var_list$var136 := variable136,
      !!var_list$var137 := variable137,
      !!var_list$var138 := variable138,
      !!var_list$var139 := variable139,
      !!var_list$var140 := variable140,
      !!var_list$var141 := variable141,
      !!var_list$var142 := variable142,
      !!var_list$var143 := variable143,
      !!var_list$var144 := variable144,
      !!var_list$var145 := variable145,
      !!var_list$var146 := variable146,
      !!var_list$var147 := variable147,
      !!var_list$var148 := variable148,
      !!var_list$var149 := variable149,
      !!var_list$var150 := variable150,
      !!var_list$var151 := variable151,
      !!var_list$var152 := variable152,
      !!var_list$var153 := variable153,
      !!var_list$var154 := variable154,
      !!var_list$var155 := variable155,
      !!var_list$var156 := variable156,
      !!var_list$var157 := variable157,
      !!var_list$var158 := variable158,
      !!var_list$var159 := variable159,
      !!var_list$var160 := variable160
      
    )
}

BPIC2017_train <- rename_back(BPIC2017_train, input_vars)
BPIC2017_test  <- rename_back(BPIC2017_test, input_vars)

write.csv(BPIC2017_train, "../../data/BPIC2017/predictions_logno/train_CRDSCCRC.csv", row.names = FALSE)
write.csv(BPIC2017_test, "../../data/BPIC2017/predictions_logno/test_CRDSCCRC.csv", row.names = FALSE)
